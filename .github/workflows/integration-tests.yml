name: Integration Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  GO_VERSION: '1.25'

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      registry-source:
        image: registry:2
        ports:
          - 5000:5000
        options: >-
          --health-cmd "wget --spider -q http://localhost:5000/v2/"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      registry-dest:
        image: registry:2
        ports:
          - 5001:5000
        options: >-
          --health-cmd "wget --spider -q http://localhost:5000/v2/"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Setup test data in source registry
        run: |
          # Pull small test images
          docker pull alpine:3.18
          docker pull alpine:3.19
          docker pull busybox:1.36

          # Tag for source registry
          docker tag alpine:3.18 localhost:5000/test/alpine:3.18
          docker tag alpine:3.19 localhost:5000/test/alpine:3.19
          docker tag busybox:1.36 localhost:5000/test/busybox:1.36

          # Push to source registry
          docker push localhost:5000/test/alpine:3.18
          docker push localhost:5000/test/alpine:3.19
          docker push localhost:5000/test/busybox:1.36

          # Verify images are in source registry
          curl -s http://localhost:5000/v2/_catalog | jq .
          curl -s http://localhost:5000/v2/test/alpine/tags/list | jq .

      - name: Build application
        run: make build

      - name: Run integration tests
        env:
          SOURCE_REGISTRY: localhost:5000
          DEST_REGISTRY: localhost:5001
          REDIS_URL: redis://localhost:6380
        run: |
          go test -v -timeout 15m -tags=integration ./tests/integration/...

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            coverage.out
            test-results.json

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      registry-source:
        image: registry:2
        ports:
          - 5000:5000
        options: >-
          --health-cmd "wget --spider -q http://localhost:5000/v2/"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      registry-dest:
        image: registry:2
        ports:
          - 5001:5000
        options: >-
          --health-cmd "wget --spider -q http://localhost:5000/v2/"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary
        run: make build

      - name: Setup test images
        run: |
          docker pull alpine:3.18
          docker tag alpine:3.18 localhost:5000/test/alpine:3.18
          docker push localhost:5000/test/alpine:3.18

      - name: Run E2E tests
        run: |
          go test -v -timeout 10m -tags=e2e ./tests/e2e/...

      - name: Upload E2E results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run performance benchmarks
        run: |
          go test -v -bench=. -benchmem -timeout 20m ./tests/performance/... | tee bench-results.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: bench-results.txt

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('bench-results.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Performance Test Results\n\n\`\`\`\n${results}\n\`\`\``
            });
