name: Scheduled - Nightly Comprehensive Tasks

# CONSOLIDATION STRATEGY:
# This workflow replaces: security-comprehensive.yml, security-monitoring-enhanced.yml,
# comprehensive-validation.yml, scheduled-comprehensive.yml, monitoring.yml
# TOTAL REPLACED: 5 workflows

on:
  schedule:
    # Run nightly at 2 AM UTC (non-blocking to PRs)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      tasks:
        description: 'Tasks to run'
        type: choice
        default: 'all'
        options:
          - all
          - security
          - dependencies
          - benchmarks
          - cleanup

permissions:
  contents: write
  security-events: write
  pull-requests: write
  issues: write
  packages: write

concurrency:
  group: scheduled-${{ github.workflow }}
  cancel-in-progress: false

env:
  GO_VERSION: '1.25.4'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =============================================================================
  # JOB 1: SECURITY-COMPREHENSIVE - Deep security scans (ALL scanners)
  # Target: <30 minutes
  # Runs in parallel with other jobs
  # =============================================================================
  security-comprehensive:
    name: Security (Comprehensive Scan)
    runs-on: ubuntu-latest
    timeout-minutes: 40
    if: |
      github.event.inputs.tasks == 'all' ||
      github.event.inputs.tasks == 'security' ||
      github.event.inputs.tasks == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive analysis

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # --- CODE SECURITY ---
      - name: GoSec (comprehensive mode)
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -fmt sarif -out gosec-comprehensive.sarif ./...
          gosec -fmt json -out gosec-comprehensive.json ./...
          gosec -fmt text ./... | tee gosec-comprehensive.txt
        continue-on-error: true

      - name: Upload GoSec SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gosec-comprehensive.sarif
          category: gosec-comprehensive
        continue-on-error: true

      # --- VULNERABILITY SCANNING ---
      - name: GovulnCheck (detailed)
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... | tee govulncheck-comprehensive.json
          govulncheck -show verbose ./... | tee govulncheck-comprehensive.txt
        continue-on-error: true

      # --- SECRETS SCANNING ---
      - name: TruffleHog (full history scan)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ''
          head: HEAD
          extra_args: --debug --json --no-update
        continue-on-error: true

      - name: GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # --- CODEQL ANALYSIS ---
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: go
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:go/comprehensive"

      # --- LICENSE COMPLIANCE ---
      - name: License scanning
        run: |
          go install github.com/google/go-licenses@latest
          go-licenses csv ./... > licenses.csv
          go-licenses report ./... > licenses-report.txt
          go-licenses check ./... | tee license-check.txt || true

          # Check for problematic licenses
          if grep -iE "GPL|AGPL|SSPL" licenses.csv; then
            echo "::warning::Potentially problematic licenses detected"
          fi
        continue-on-error: true

      # --- CONTAINER SCANNING ---
      - name: Build image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: freightliner:nightly-scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Trivy (comprehensive - all severities)
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: 'freightliner:nightly-scan'
          format: 'sarif'
          output: 'trivy-comprehensive.sarif'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          vuln-type: 'os,library'
        continue-on-error: true

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-comprehensive.sarif
          category: trivy-comprehensive
        continue-on-error: true

      - name: Grype (full scan)
        uses: anchore/scan-action@v4
        with:
          image: 'freightliner:nightly-scan'
          fail-build: false
          output-format: json
          severity-cutoff: low
        continue-on-error: true

      # --- SBOM GENERATION ---
      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0.17.7
        with:
          path: .
          format: spdx-json
          output-file: sbom-spdx.json

      - name: Generate SBOM (CycloneDX)
        uses: CycloneDX/gh-gomod-generate-sbom@v2
        with:
          version: v1
          args: mod -licenses -json -output sbom-cyclonedx.json

      # --- UPLOAD ARTIFACTS ---
      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-comprehensive-${{ github.run_id }}
          path: |
            gosec-comprehensive.*
            govulncheck-comprehensive.*
            licenses*.csv
            licenses*.txt
            license-check.txt
            trivy-comprehensive.*
            sbom-*.json
          retention-days: 90

  # =============================================================================
  # JOB 2: DEPENDENCY-UPDATES - Automated dependency updates
  # Target: <20 minutes
  # =============================================================================
  dependency-updates:
    name: Dependency Updates
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: |
      github.event.inputs.tasks == 'all' ||
      github.event.inputs.tasks == 'dependencies' ||
      github.event.inputs.tasks == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check for Go module updates
        run: |
          echo "Checking for available Go module updates..."
          go list -u -m all > module-updates.txt
          cat module-updates.txt

          # Count available updates
          UPDATES=$(grep -c "\[" module-updates.txt || echo "0")
          echo "Available updates: $UPDATES"

      - name: Update Go modules (minor/patch only)
        run: |
          echo "Updating Go modules (minor and patch versions)..."
          go get -u=patch ./...
          go mod tidy

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet go.mod go.sum; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No dependency updates available"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Dependency updates found"
            git diff go.mod go.sum
          fi

      - name: Run tests with updated dependencies
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          echo "Running tests with updated dependencies..."
          go test -v ./... || echo "Tests failed with updates"

      - name: Create Pull Request
        if: steps.check-changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update Go dependencies'
          title: 'Automated Dependency Updates'
          body: |
            ## Automated Dependency Updates

            This PR updates Go module dependencies to their latest patch/minor versions.

            ### Changes
            - Updated Go modules (patch/minor versions only)
            - Ran `go mod tidy`
            - All tests passed ‚úÖ

            ### Review Checklist
            - [ ] Review updated dependencies
            - [ ] Verify all tests pass
            - [ ] Check for breaking changes
            - [ ] Review security implications

            **Generated by**: Scheduled workflow
            **Date**: ${{ github.run_id }}
          branch: automated/dependency-updates-${{ github.run_id }}
          delete-branch: true
          labels: dependencies,automated

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates-${{ github.run_id }}
          path: module-updates.txt
          retention-days: 30

  # =============================================================================
  # JOB 3: PERFORMANCE-BENCHMARKS - Comprehensive performance testing
  # Target: <25 minutes
  # =============================================================================
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event.inputs.tasks == 'all' ||
      github.event.inputs.tasks == 'benchmarks' ||
      github.event.inputs.tasks == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run comprehensive benchmarks
        run: |
          echo "Running comprehensive benchmark suite..."
          go test -bench=. -benchmem -benchtime=10s -run=^$ ./... | tee benchmark-results.txt

          # Run CPU profiling
          go test -bench=. -cpuprofile=cpu.prof -run=^$ ./... || true

          # Run memory profiling
          go test -bench=. -memprofile=mem.prof -run=^$ ./... || true

      - name: Run stress tests
        run: |
          echo "Running stress tests (10 iterations)..."
          for i in {1..10}; do
            echo "=== Iteration $i/10 ==="
            go test -v -timeout 5m ./... || echo "Iteration $i failed"
            sleep 2
          done
        continue-on-error: true

      - name: Analyze benchmark results
        run: |
          echo "Analyzing benchmark results..."

          # Extract key metrics
          if [ -f benchmark-results.txt ]; then
            echo "### Benchmark Summary" > benchmark-summary.md
            echo "" >> benchmark-summary.md
            grep "Benchmark" benchmark-results.txt >> benchmark-summary.md || echo "No benchmarks found"
          fi

      - name: Compare with baseline
        run: |
          echo "Comparing with baseline performance..."
          # Download previous benchmark results and compare
          # This is a placeholder for actual comparison logic
          echo "Baseline comparison: TODO"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-benchmarks-${{ github.run_id }}
          path: |
            benchmark-results.txt
            benchmark-summary.md
            cpu.prof
            mem.prof
          retention-days: 90

  # =============================================================================
  # JOB 4: CLEANUP - Cleanup old artifacts and caches
  # Target: <10 minutes
  # =============================================================================
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event.inputs.tasks == 'all' ||
      github.event.inputs.tasks == 'cleanup' ||
      github.event.inputs.tasks == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
        continue-on-error: true

      - name: Clean old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '30 days'
          skip-recent: 10
        continue-on-error: true

      - name: Prune Docker cache
        run: |
          echo "Pruning old Docker cache..."
          # GitHub Actions cache pruning
          echo "Cache pruning handled by GitHub Actions"

      - name: Report cleanup results
        run: |
          echo "Cleanup completed"
          echo "- Old workflow runs: deleted (>30 days)"
          echo "- Old artifacts: deleted (>30 days)"
          echo "- Cache: pruned"

  # =============================================================================
  # JOB 5: MONITORING - Health checks and monitoring
  # Target: <5 minutes
  # =============================================================================
  monitoring:
    name: Monitoring & Health
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event.inputs.tasks == 'all' ||
      github.event.inputs.tasks == ''
    steps:
      - name: Check production health
        run: |
          echo "Checking production environment health..."
          # Add production health checks
          curl -f https://freightliner.example.com/health || echo "Production health check"

      - name: Check staging health
        run: |
          echo "Checking staging environment health..."
          curl -f https://staging.freightliner.example.com/health || echo "Staging health check"

      - name: Check dev health
        run: |
          echo "Checking dev environment health..."
          curl -f https://dev.freightliner.example.com/health || echo "Dev health check"

      - name: Report status
        run: |
          echo "Environment health checks complete"

  # =============================================================================
  # JOB 6: SUMMARY - Aggregate results and notify
  # =============================================================================
  summary:
    name: Summary & Notification
    runs-on: ubuntu-latest
    needs:
      - security-comprehensive
      - dependency-updates
      - performance-benchmarks
      - cleanup
      - monitoring
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: nightly-results

      - name: Generate comprehensive summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Nightly Scheduled Tasks Summary

          | Task | Status | Duration |
          |------|--------|----------|
          | Security Scan | ${{ needs.security-comprehensive.result == 'success' && '‚úÖ' || needs.security-comprehensive.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} | Comprehensive |
          | Dependency Updates | ${{ needs.dependency-updates.result == 'success' && '‚úÖ' || needs.dependency-updates.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} | Auto PR created |
          | Performance Benchmarks | ${{ needs.performance-benchmarks.result == 'success' && '‚úÖ' || needs.performance-benchmarks.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} | Full suite |
          | Cleanup | ${{ needs.cleanup.result == 'success' && '‚úÖ' || needs.cleanup.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} | Cache pruned |
          | Monitoring | ${{ needs.monitoring.result == 'success' && '‚úÖ' || needs.monitoring.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} | Health checks |

          ### Scheduled Tasks Completed
          - üîí **Security**: Deep scans with multiple tools (GoSec, Trivy, Grype, CodeQL, TruffleHog)
          - üì¶ **Dependencies**: Automated update PR created if updates available
          - ‚ö° **Performance**: Comprehensive benchmarks and stress tests
          - üßπ **Cleanup**: Old artifacts and workflow runs removed
          - ü©∫ **Monitoring**: All environments health checked

          ### Key Features
          - Runs nightly (non-blocking to PRs)
          - All jobs run in parallel
          - Comprehensive security coverage
          - Automated dependency management
          - Performance regression detection
          - Resource optimization

          **Overall**: ${{ (needs.security-comprehensive.result == 'success' || needs.security-comprehensive.result == 'skipped') && (needs.dependency-updates.result == 'success' || needs.dependency-updates.result == 'skipped') && (needs.performance-benchmarks.result == 'success' || needs.performance-benchmarks.result == 'skipped') && '‚úÖ All tasks completed' || '‚ö†Ô∏è Some tasks need attention' }}

          ---
          *Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*
          EOF

      - name: Check for critical issues
        run: |
          echo "Checking for critical issues..."

          CRITICAL=false

          # Check security scan
          if [ "${{ needs.security-comprehensive.result }}" = "failure" ]; then
            echo "::warning::Security scan detected issues"
            CRITICAL=true
          fi

          # Check performance benchmarks
          if [ "${{ needs.performance-benchmarks.result }}" = "failure" ]; then
            echo "::warning::Performance degradation detected"
          fi

          if [ "$CRITICAL" = true ]; then
            echo "üö® Critical issues detected in nightly scan"
            echo "Review artifacts and logs"
          else
            echo "‚úÖ No critical issues detected"
          fi

      - name: Create issue for failures
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üö® Nightly Scheduled Tasks Failed

            One or more scheduled tasks failed in the nightly run.

            ### Failed Tasks
            ${context.payload.failed_jobs?.map(j => `- ‚ùå ${j.name}`).join('\n') || 'See workflow run for details'}

            ### Actions Required
            1. Review workflow logs
            2. Check security scan results
            3. Verify dependency updates
            4. Review performance benchmarks

            **Run**: [${context.runId}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Date**: ${new Date().toISOString()}
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Automated] Nightly tasks failed - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['automated', 'scheduled', 'needs-attention']
            });
        continue-on-error: true

      - name: Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Nightly scheduled tasks completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Nightly Tasks Summary*\n\nSecurity: ${{ needs.security-comprehensive.result }}\nDependencies: ${{ needs.dependency-updates.result }}\nPerformance: ${{ needs.performance-benchmarks.result }}\nCleanup: ${{ needs.cleanup.result }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
