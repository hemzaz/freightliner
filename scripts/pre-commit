#!/bin/bash
# Pre-commit hook to organize imports and run linting

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".go$")

# Exit if no Go files are staged
if [[ "$STAGED_GO_FILES" = "" ]]; then
  exit 0
fi

echo "==> Running pre-commit checks on Go files..."

# Check if required tools are installed
if ! command -v goimports &> /dev/null; then
  echo "Error: goimports is not installed. Install it with 'go install golang.org/x/tools/cmd/goimports@latest'"
  exit 1
fi

if ! command -v golangci-lint &> /dev/null; then
  echo "Error: golangci-lint is not installed. Install it with 'go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest'"
  exit 1
fi

# Format all staged Go files and re-stage them
echo "Running goimports on staged files..."
for FILE in $STAGED_GO_FILES; do
  goimports -w -local freightliner "$FILE"
  git add "$FILE"
done

# Run linting on staged files
echo "Running golangci-lint on staged files..."
LINT_RESULT=0
for FILE in $STAGED_GO_FILES; do
  golangci-lint run --fast "$FILE"
  if [ $? -ne 0 ]; then
    LINT_RESULT=1
  fi
done

# Exit with error if linting failed
if [ $LINT_RESULT -ne 0 ]; then
  echo "Error: Linting failed. Please fix the issues before committing."
  exit 1
fi

echo "==> Pre-commit checks passed!"
exit 0

